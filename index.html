<!DOCTYPE html>
<title>Seal breaker simulator</title>
<meta charset="utf-8">
<meta name=viewport content='width=device-width,initial-scale=1,maximum-scale=1'>
<link rel="stylesheet" href="/common.css">
<link rel="stylesheet" href="style.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Monda:wght@700&family=Shippori+Antique&family=Sofia+Sans+Condensed:wght@600;800&display=swap" rel="stylesheet">
<time></time>
<main>
    <button>1 set</button>
    <button>100000 sets</button>
    <p>16 pieces<label><input id="toggle-piece" type="checkbox"></label>13 pieces</p>
    <section>
        <article></article>
        Seal opened: <output></output>
    </section>
    <figure>
        <figcaption>
            Distribution of number of seals required for a full set
        </figcaption>
        <span>Sets acquired: <output id="multiple"></output></span>
    </figure>
    <ul>
        <li>26_ means 260 to 269.
        <li>Theoretical expectation: 267.3 (16 pieces) / 249.6 (13 pieces)</li>
        <li><input type="range" min="50" max="99" value="90" id="CI"><output>90</output>% confidence interval<mark style="background:chartreuse">　</mark>
        <li><input type="range" min="50" max="99" value="90" id="safety"><output>90</output>% safety<mark style="background:orange">　</mark>
    </ul>
</main>
<footer>
    <a href="/analyzer/">Analyzer</a>・
    <a href="/property/">Property</a>
    <cite>By V. Man (@AEOQ) GuRan GCC 2021</cite>
</footer>
<script type="module">
    import {A,E,O,Q} from 'https://aeoq.github.io/AEOQ.mjs'
    import {} from '/UIX.js'

    window.onhashchange(location.hash.substring(1) || 'en');
    const Seal = {
        rates: [17.16,16.09,15.01,13.94,12.87,11.8,10.73,9.66,8.59,7.52,6.45,5.38,4.31,3.24,2.17,1.1],
        limit: [15,   16,   17,   18,   19,   20,  22,   25,  30,  35,  40,  45,  50,  60,  90,  120],
    }
    Q('#toggle-piece').onchange = ev => Q('progress:nth-of-type(-n+3),img:nth-last-of-type(-n+3)', el => el.hidden = ev.target.checked);
    Q('article').append(...[...Array(16)].map((_, i) => E('img', {src: `S${i+1}.webp`})));
    Q('article').before(...Seal.limit.map((max, i) => E('progress', {
        title: i + 1, 
        max: max + 1, value: 0, 
        dataset: {rate: Seal.rates[i]}}
    )));
    Q('figure').append(...[...Array(62)].map((_, i) => E('p', {title: i + 1})));
    Q('button:first-child').onclick = () => {
        Q('figure').hidden = true;
        Q('section').hidden = false;
        Q('progress,output', el => el.value = 0);
        Q('.done', el => el.classList.remove('done'));
        requestAnimationFrame(single);
    }
    Q('button:nth-child(2)').onclick = () => {
        Q('figure').hidden = false;
        Q('section').hidden = true;
        Q('#multiple').value = sets = 0;
        Q('figure p', p => p.frequency = 0);
        Q('figure').scrollIntoView();
        Q('figure').scrollLeft = 287;
        requestAnimationFrame(multiple);
    }

    let last, output = Q('section output');
    const single = t => {
        last ??= t;
        let current = Q('progress:nth-child(1 of :not(.done):not([hidden]))');
        if (t - last > 25 && current) {
            last = t;
            current.value += 1;
            output.value = parseInt(output.value) + 1;
            if (current.value >= current.max || Math.random() * 100 <= parseFloat(current.dataset.rate)) {
                current.classList.add('done');
                let items = [Q('article img:not(.done):not([hidden])')].flat();
                items[Math.floor(Math.random()*items.length)].classList.add('done');
            }
        } else if (!current) return;
        requestAnimationFrame(single);
    }
    let sets = 0;
    const multiple = t => {
        last ??= t;
        if (t - last > 1 && sets < 100000) {
            last = t; for (let s = 0; s < 300; s++) {
            sets++;
            let times = [];
            for (let p = Q('#toggle-piece').checked ? 3 : 0; p <= 15; p++)
                for (let t = 1; t <= Seal.limit[p]; t++) {
                    if (Math.random() * 100 <= Seal.rates[p]) {
                        times[p] = t;
                        break;
                    }
                    times[p] = t + 1;
                }
            times = times.reduce((sum, t) => sum += t, 0);
            let p = Q(`p[title='${Math.floor(times/10)}']`);
            p.frequency ??= 0;
            p.frequency += 1;
            p.style.height = p.frequency/200 + 'em'; }
            Q('#multiple').value = sets;
        } else if (sets >= 100000) return [Chart.confidence(), Chart.safety()];
        requestAnimationFrame(multiple);
    }
    const Chart = {}
    Chart.getData = () => {
        Chart.data = Q('figure p').map(p => p.frequency);
        let total = Chart.data.reduce((sum, t) => sum += t, 0);
        Chart.data = Chart.data.map(t => t/total);
    }
    Chart.confidence = (percent = 90) => {
        Q('figure p.mark', p => p.classList.remove('mark'));
        let interval = [], lower = 0.5 - percent/200;
        Chart.data ?? Chart.getData();
        let sum = 0;
        for (let i = 0; i < 27; i++)
            if ((sum += Chart.data[i]) >= lower) {
                interval[0] = i;
                break;
            }
        sum = 1;
        for (let i = 55; i > 27; i--)
            if ((sum -= Chart.data[i]) <= 1 - lower) {
                interval[1] = i;
                break;
            } 
        Q(`figure p:is(:nth-child(${interval[0]+2}),:nth-child(${interval[1]+2}))`, p => p.classList.add('mark'));
    }
    Chart.safety = (percent = 90) => {
        Q('figure p.safe')?.classList.remove('safe');
        let interval = [], lower = percent/100;
        Chart.data ?? Chart.getData();
        let sum = 0;
        for (let i = 0; i < 55; i++)
            if ((sum += Chart.data[i]) >= lower) {
                interval[0] = i;
                break;
            }
        Q(`figure p:nth-child(${interval[0]+2})`).classList.add('safe');
    }

    Q('#CI').oninput = ev => {
        ev.target.nextElementSibling.value = ev.target.value;
        Chart.confidence(ev.target.value);
    }
    Q('#safety').oninput = ev => {
        ev.target.nextElementSibling.value = ev.target.value;
        Chart.safety(ev.target.value);
    }
</script>
